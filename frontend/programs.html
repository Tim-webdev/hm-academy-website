<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Program</title>
  <link rel="stylesheet" href="Css/programs.css">
</head>
<body>
  <div class="container">
    <h2>Select a Course Package</h2>
    <select id="program-select">
      <option value="">-- choose your program --</option>
      <option value="compApp">Computer Appreciation ‚Äì ‚Ç¶67,500</option>
      <option value="graphic">Graphic Design Certificate ‚Äì ‚Ç¶118,500</option>
      <option value="network">Networking Certificate ‚Äì ‚Ç¶111,800</option>
      <option value="coding">Coding Certificate ‚Äì ‚Ç¶188,500</option>
      <option value="digital">Digital Marketing Certificate ‚Äì ‚Ç¶168,500</option>
      <option value="video">Video Editing Certificate ‚Äì ‚Ç¶148,500</option>
    </select>
    <button id="pay-btn">Pay via Paystack</button>
    <p id="message" style="color:red;"></p>
  </div>

  <!-- ‚úÖ Paystack Inline Script -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    // Backend URL
    const BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:5000/api/payments'
      : 'https://hm-academy-website.onrender.com/api/payments';

    // Get student email (saved in localStorage after login)
    const studentEmail = localStorage.getItem('userEmail') || prompt('Enter your email');

    // Program mapping
    const mapping = {
      compApp: ['Computer Appreciation ‚Äì Certificate', 67500],
      graphic: ['Graphic Design ‚Äì Certificate', 118500],
      network: ['Networking ‚Äì Certificate', 111800],
      coding: ['Coding ‚Äì Certificate', 188500],
      digital: ['Digital Marketing ‚Äì Certificate', 168500],
      video: ['Video Editing ‚Äì Certificate', 148500]
    };

    document.getElementById('pay-btn').addEventListener('click', async () => {
      const sel = document.getElementById('program-select');
      if (!sel.value) return alert('‚ö†Ô∏è Please choose a program first');

      const [programName, amount] = mapping[sel.value];

      try {
        console.log("üü° Initializing payment with backend...");
        // ‚úÖ Step 1: Initialize payment with backend
        const res = await fetch(`${BASE_URL}/initialize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: studentEmail, programName, amount })
        });

        // Handle non-JSON error pages (like 404 HTML)
        if (!res.headers.get("content-type")?.includes("application/json")) {
          throw new Error("Invalid response from server (not JSON)");
        }

        const data = await res.json();
        console.log("üü¢ Backend response (initialize):", data);

        if (!res.ok || !data.success) {
          return document.getElementById('message').textContent = data.message || "‚ö†Ô∏è Error starting payment";
        }

        // ‚úÖ Step 2: Open Paystack Checkout
        console.log("üü° Opening Paystack popup...");
        const handler = PaystackPop.setup({
          key: "pk_live_6bcb27680665d9514ebf26dc88bddd408beaa437", // ‚ö†Ô∏è Replace with test key in dev
          email: studentEmail,
          amount: amount * 100, // kobo
          ref: data.reference, // unique ref from backend
          callback: function(response) {
            console.log("üü¢ Paystack returned callback:", response);

            // Wrap verification inside async IIFE
            (async () => {
              try {
                console.log("üü° Verifying payment with backend...");
                const verify = await fetch(`${BASE_URL}/verify/${response.reference}`);
                const result = await verify.json();
                console.log("üü¢ Backend response (verify):", result);

                if (result.success) {
                  alert('‚úÖ Payment Successful! Your account is now active.');
                  window.location.href = 'student-profile.html';
                } else {
                  alert('‚ùå Payment not verified. Please contact support.');
                }
              } catch (err) {
                console.error("üî¥ Verify error:", err);
                alert("‚ö†Ô∏è Error verifying payment. Try again later.");
              }
            })();
          },
          onClose: function() {
            console.warn('‚ö†Ô∏è Payment window closed.');
            alert('‚ö†Ô∏è Payment window closed.');
          }
        });

        handler.openIframe();
      } catch (err) {
        console.error("üî¥ Payment error:", err);
        document.getElementById('message').textContent = "‚ùå Server error. Try again later.";
      }
    });
  </script>
</body>
</html>
